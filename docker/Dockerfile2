FROM nvidia/cudagl:11.4.2-runtime-ubuntu20.04

ENV DEBIAN_FRONTEND noninteractive

##################
# get keys for apt
RUN apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/3bf863cc.pub
RUN apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub

##################
# (1-1) Install prerequisites
RUN apt update && apt install -y \
    sudo curl wget git

##################
# Install NVIDIA drivers, including X graphic drivers
# sudo nvidia-xconfig -a --virtual=$RESOLUTION --allow-empty-initial-configuration --enable-all-gpus --busid $BUS_ID
ENV DRIVER_VERSION=460.91.03
RUN apt install -y kmod pkg-config
RUN cd /tmp && \
    curl -fSsl -O https://us.download.nvidia.com/tesla/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run && \
    sh NVIDIA-Linux-x86_64-$DRIVER_VERSION.run -x && \
    cd NVIDIA-Linux-x86_64-$DRIVER_VERSION && \
    ./nvidia-installer --silent \
    --no-kernel-module \
    --install-compat32-libs \
    --no-nouveau-check \
    --no-nvidia-modprobe \
    --no-rpms \
    --no-backup \
    --no-check-for-alternate-installs \
    --no-libglx-indirect \
    --no-install-libglvnd && \
    mkdir -p /usr/src/nvidia-$DRIVER_VERSION && \
    mv LICENSE mkprecompiled kernel /usr/src/nvidia-$DRIVER_VERSION && \
    sed '9,${/^\(kernel\|LICENSE\)/!d}' .manifest > /usr/src/nvidia-$DRIVER_VERSION/.manifest

##################
# Install XOrg
# Run example:
# $ sudo Xorg $DISPLAY
RUN apt install -y xinit

##################
# Install X11VNC
# Run example:
# $ x11vnc -display $DISPLAY -passwd $VNCPASS -forever -rfbport 5900
RUN apt install -y x11vnc

##################
# Install NoVNC
# Run example:
# $ /usr/bin/websockify -D --web=/usr/share/novnc/ $NOVNC_PORT localhost:5900
RUN apt install -y novnc websockify 

#########################
# Install x11 apps
# $ xeyes
# $ glxgears
RUN apt install -y mesa-utils x11-apps

##################
# Install RyujinX
# Run example:
# $ /home/guest/.local/share/Ryujinx/Ryujinx
# https://github.com/Ryujinx/release-channel-master/releases
COPY ./docker/install_ryujinx.sh /install_ryujinx.sh
RUN apt install -y \
    automake autoconf libssl-dev xorg-dev libvncserver-dev \
    sudo bash /install_ryujinx.sh

# Error
# Unhandled exception. System.DllNotFoundException: Unable to load shared library 'libX11' or one of its dependencies. In order to help diagnose loading problems, consider setting the LD_DEBUG environment variable: liblibX11: cannot open shared object file: No such file or directory
#   at Ryujinx.Program.XInitThreads()
#   at Ryujinx.Program.Main(String[] args) in D:\a\Ryujinx\Ryujinx\Ryujinx\Program.cs:line 104
# Aborted (core dumped)

CMD ["bash"]

# docker run --privileged -it --rm --gpus all   -p 8081:8081   -p 6000:6000   -p 6006:6006   -e RESOLUTION=1280x800   -e VNCPASS=pass   -e DISPLAY=:1   -e BUS_ID=13:0:0   -e NOVNC_PORT=8081   -e API_PORT=6000   -e API_HOST=0.0.0.0   -e API_FILE_PATH=/workspace/libultimate/run_server.py   -v "/home/ruirui_nis/workspace/DeepSmashProject:/workspace"   -v "/mnt/bigdata/00_students/ruirui_nis/DeepSmashProject/games:/data/games"   -v "/mnt/bigdata/00_students/ruirui_nis/DeepSmashProject/firmware:/data/firmware"   -v "/mnt/bigdata/00_students/ruirui_nis/DeepSmashProject/keys:/data/keys"   --name cudagl-test cudagl-test:latest
# System.ComponentModel.Win32Exception (2): An error occurred trying to start process '/root/.config/Ryujinx' with working directory '/'. No such file or directory
